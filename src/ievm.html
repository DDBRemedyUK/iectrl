<!DOCTYPE html><html lang="en"><head><title>src/ievm</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="src/ievm"><meta name="groc-project-path" content="src/ievm.coffee"><meta name="groc-github-url" content="https://github.com/xdissent/iectrl"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/xdissent/iectrl/blob/master/src/ievm.coffee">src/ievm.coffee</a></div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><h1 id="ievm">IEVM</h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>This class represents an ievms VM and its current state, as queried through
Virtualbox and the <a href="http://modern.ie">modern.ie</a> website.</p></div></div><div class="code"><div class="wrapper"><span class="nv">fs = </span><span class="nx">require</span> <span class="s">&#39;fs&#39;</span>
<span class="nv">path = </span><span class="nx">require</span> <span class="s">&#39;path&#39;</span>
<span class="nv">Q = </span><span class="nx">require</span> <span class="s">&#39;q&#39;</span>
<span class="nv">url = </span><span class="nx">require</span> <span class="s">&#39;url&#39;</span>
<span class="nv">http = </span><span class="nx">require</span> <span class="s">&#39;http&#39;</span>
<span class="nv">child_process = </span><span class="nx">require</span> <span class="s">&#39;child_process&#39;</span>
<span class="nv">debug = </span><span class="nx">require</span> <span class="s">&#39;debug&#39;</span>

<span class="k">class</span> <span class="nx">IEVM</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="class-properties">Class Properties</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A list of all available IE versions.</p></div></div><div class="code"><div class="wrapper">  <span class="vi">@versions: </span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A list of all available OS names.</p></div></div><div class="code"><div class="wrapper">  <span class="vi">@oses: </span><span class="p">[</span><span class="s">&#39;WinXP&#39;</span><span class="p">,</span> <span class="s">&#39;Vista&#39;</span><span class="p">,</span> <span class="s">&#39;Win7&#39;</span><span class="p">,</span> <span class="s">&#39;Win8&#39;</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A list of all supported ievms version/OS combos.</p></div></div><div class="code"><div class="wrapper">  <span class="vi">@names: </span><span class="p">[</span>
    <span class="s">&#39;IE6 - WinXP&#39;</span>
    <span class="s">&#39;IE7 - WinXP&#39;</span>
    <span class="s">&#39;IE8 - WinXP&#39;</span>
    <span class="s">&#39;IE7 - Vista&#39;</span>
    <span class="s">&#39;IE8 - Win7&#39;</span>
    <span class="s">&#39;IE9 - Win7&#39;</span>
    <span class="s">&#39;IE10 - Win7&#39;</span>
    <span class="s">&#39;IE10 - Win8&#39;</span>
    <span class="s">&#39;IE11 - Win7&#39;</span>
  <span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A list of possible VM statuses.</p></div></div><div class="code"><div class="wrapper">  <span class="vi">@status:</span>
    <span class="nv">MISSING: </span><span class="o">-</span><span class="mi">1</span>
    <span class="nv">POWEROFF: </span><span class="mi">0</span>
    <span class="nv">RUNNING: </span><span class="mi">1</span>
    <span class="nv">PAUSED: </span><span class="mi">2</span>
    <span class="nv">SAVED: </span><span class="mi">3</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A list of initial rearms available per OS. Hilarious.</p></div></div><div class="code"><div class="wrapper">  <span class="vi">@rearms:</span>
    <span class="nv">WinXP: </span><span class="mi">0</span>
    <span class="nv">Vista: </span><span class="mi">0</span>
    <span class="nv">Win7: </span><span class="mi">5</span>
    <span class="nv">Win8: </span><span class="mi">0</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The ievms home (<code>INSTALL_PATH</code> in ievms parlance).</p></div></div><div class="code"><div class="wrapper">  <span class="vi">@ievmsHome: </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">INSTALL_PATH</span> <span class="o">?</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">HOME</span><span class="p">,</span> <span class="s">&#39;.ievms&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The command used to install virtual machines via ievms.</p></div></div><div class="code"><div class="wrapper">  <span class="vi">@ievmsCmd: </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">IEVMS_CMD</span> <span class="o">?</span>
    <span class="s">&#39;curl -s https://raw.github.com/xdissent/ievms/master/ievms.sh | bash&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The host IP as seen by the VM.</p></div></div><div class="code"><div class="wrapper">  <span class="vi">@hostIp = </span><span class="s">&#39;10.0.2.2&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="class-methods">Class Methods</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Run ievms shell script with a given environment. A debug function may be
passed (like <code>console.log</code>) which will be called for each line of ievms
output. Returns a promise which will resolve when ievms is finished.</p></div></div><div class="code"><div class="wrapper">  <span class="vi">@ievms: </span><span class="nf">(env, debug) -&gt;</span>
    <span class="nv">deferred = </span><span class="nx">Q</span><span class="p">.</span><span class="nx">defer</span><span class="p">()</span>
    <span class="nv">cmd = </span><span class="p">[</span><span class="s">&#39;bash&#39;</span><span class="p">,</span> <span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="nx">@ievmsCmd</span><span class="p">]</span>
    <span class="nx">debug</span> <span class="s">&quot;ievms: </span><span class="si">#{</span><span class="nx">cmd</span><span class="p">.</span><span class="nx">join</span> <span class="s">&#39; &#39;</span><span class="si">}</span><span class="s">&quot;</span> <span class="k">if</span> <span class="nx">debug</span><span class="o">?</span>
    <span class="nv">ievms = </span><span class="nx">child_process</span><span class="p">.</span><span class="nx">spawn</span> <span class="nx">cmd</span><span class="p">.</span><span class="nx">shift</span><span class="p">(),</span> <span class="nx">cmd</span><span class="p">,</span> <span class="nv">env: </span><span class="nx">env</span>
    <span class="nx">ievms</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;error&#39;</span><span class="p">,</span> <span class="nf">(err) -&gt;</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span> <span class="nx">err</span>
    <span class="nx">ievms</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;exit&#39;</span><span class="p">,</span> <span class="nf">-&gt;</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span> <span class="kc">true</span>
    <span class="k">if</span> <span class="nx">debug</span><span class="o">?</span> <span class="k">then</span> <span class="nx">ievms</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;readable&#39;</span><span class="p">,</span> <span class="nf">-&gt;</span>
      <span class="nv">out = </span><span class="nx">ievms</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">read</span><span class="p">()</span>
      <span class="nx">debug</span> <span class="s">&quot;ievms: </span><span class="si">#{</span><span class="nx">l</span><span class="si">}</span><span class="s">&quot;</span> <span class="k">for</span> <span class="nx">l</span> <span class="k">in</span> <span class="nx">out</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">trim</span><span class="p">().</span><span class="nx">split</span> <span class="s">&quot;\n&quot;</span> <span class="k">if</span> <span class="nx">out</span><span class="o">?</span>
    <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Build an array with one instance of each possible IEVM type.</p></div></div><div class="code"><div class="wrapper">  <span class="vi">@all: </span><span class="nf">-&gt;</span> <span class="k">new</span> <span class="nx">@</span> <span class="nx">n</span> <span class="k">for</span> <span class="nx">n</span> <span class="k">in</span> <span class="nx">@names</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Build an array of all IEVM instances that match the given name, which may be
a specific VM (<code>IE6 - WinXP</code>), an IE version number (<code>9</code> or <code>7</code>) or an OS
name (<code>WinXP</code> or <code>Vista</code>).</p></div></div><div class="code"><div class="wrapper">  <span class="vi">@find: </span><span class="nf">(name) -&gt;</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&#39;No name specified&#39;</span> <span class="k">unless</span> <span class="nx">name</span><span class="o">?</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">name</span> <span class="o">isnt</span> <span class="s">&#39;string&#39;</span> <span class="o">and</span> <span class="k">typeof</span> <span class="nx">name</span> <span class="o">isnt</span> <span class="s">&#39;number&#39;</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Invalid name: &#39;</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">&#39;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="k">new</span> <span class="nx">IEVM</span> <span class="nx">name</span><span class="p">]</span> <span class="k">if</span> <span class="nx">name</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/^IE/</span>
    <span class="k">if</span> <span class="nx">name</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/^(Win|Vista)/</span>
      <span class="k">return</span> <span class="p">(</span><span class="k">new</span> <span class="nx">IEVM</span> <span class="nx">n</span> <span class="k">for</span> <span class="nx">n</span> <span class="k">in</span> <span class="nx">@names</span> <span class="k">when</span> <span class="nx">n</span><span class="p">.</span><span class="nx">match</span> <span class="s">&quot;- </span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="o">!</span><span class="nx">name</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^\d+$/</span><span class="p">)</span> <span class="o">or</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">@versions</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Invalid name: &#39;</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">&#39;&quot;</span>
    <span class="k">new</span> <span class="nx">IEVM</span> <span class="nx">n</span> <span class="k">for</span> <span class="nx">n</span> <span class="k">in</span> <span class="nx">@names</span> <span class="k">when</span> <span class="nx">n</span><span class="p">.</span><span class="nx">match</span> <span class="s">&quot;IE</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Construct a <code>VBoxManage</code> command with arguments. Adds single quotes to all
arguments for shell "safety".</p></div></div><div class="code"><div class="wrapper">  <span class="vi">@vbm: </span><span class="nf">(cmd, args=[]) -&gt;</span>
    <span class="nv">args = </span><span class="p">(</span><span class="s">&quot;&#39;</span><span class="si">#{</span><span class="nx">a</span><span class="si">}</span><span class="s">&#39;&quot;</span> <span class="k">for</span> <span class="nx">a</span> <span class="k">in</span> <span class="nx">args</span><span class="p">).</span><span class="nx">join</span> <span class="s">&#39; &#39;</span>
    <span class="s">&quot;VBoxManage </span><span class="si">#{</span><span class="nx">cmd</span><span class="si">}</span><span class="s"> </span><span class="si">#{</span><span class="nx">args</span><span class="si">}</span><span class="s">&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Parse the output from <code>VBoxManage list hdds</code> into an object.</p></div></div><div class="code"><div class="wrapper">  <span class="vi">@parseHdds: </span><span class="nf">(s) -&gt;</span>
    <span class="nv">hdds = </span><span class="p">{}</span>
    <span class="k">for</span> <span class="nx">chunk</span> <span class="k">in</span> <span class="nx">s</span><span class="p">.</span><span class="nx">split</span> <span class="s">&quot;\n\n&quot;</span>
      <span class="nv">hdd = </span><span class="p">{}</span>
      <span class="k">for</span> <span class="nx">line</span> <span class="k">in</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">split</span> <span class="s">&quot;\n&quot;</span>
        <span class="nv">pieces = </span><span class="nx">line</span><span class="p">.</span><span class="nx">split</span> <span class="s">&#39;:&#39;</span>
        <span class="nx">hdd</span><span class="p">[</span><span class="nx">pieces</span><span class="p">.</span><span class="nx">shift</span><span class="p">()]</span> <span class="o">=</span> <span class="nx">pieces</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">).</span><span class="nx">trim</span><span class="p">()</span>
      <span class="nx">hdds</span><span class="p">[</span><span class="nx">hdd</span><span class="p">.</span><span class="nx">UUID</span><span class="p">]</span> <span class="o">=</span> <span class="nx">hdd</span>
    <span class="nx">hdds</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Promise the parsed output from <code>VBoxManage list hdds</code>.</p></div></div><div class="code"><div class="wrapper">  <span class="vi">@hdds: </span><span class="nf">-&gt;</span>
    <span class="nv">deferred = </span><span class="nx">Q</span><span class="p">.</span><span class="nx">defer</span><span class="p">()</span>
    <span class="nx">child_process</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">@vbm</span><span class="p">(</span><span class="s">&#39;list&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;hdds&#39;</span><span class="p">]),</span> <span class="nf">(err, stdout, stderr) =&gt;</span>
      <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span><span class="o">?</span>
      <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">@parseHdds</span> <span class="nx">stdout</span>
    <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Determine the status name for a given status value.</p></div></div><div class="code"><div class="wrapper">  <span class="vi">@statusName: </span><span class="nf">(status) -&gt;</span> <span class="p">(</span><span class="nx">k</span> <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">@status</span> <span class="k">when</span> <span class="nx">v</span> <span class="o">is</span> <span class="nx">status</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="instance-methods">Instance Methods</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="constructor">Constructor</h3></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create a new IEVM instance for a given ievms VM name. The name is validated
against all supported ievms names. The IE version and OS are extracted from
the name and validated as well.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">constructor: </span><span class="nf">(@name) -&gt;</span>
    <span class="k">if</span> <span class="nx">@name</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">@constructor</span><span class="p">.</span><span class="nx">names</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Invalid name: &#39;</span><span class="si">#{</span><span class="nx">@name</span><span class="si">}</span><span class="s">&#39;&quot;</span>
    <span class="nv">pieces = </span><span class="nx">@name</span><span class="p">.</span><span class="nx">split</span> <span class="s">&#39; &#39;</span>
    <span class="vi">@version = </span><span class="nb">parseInt</span> <span class="nx">pieces</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">replace</span> <span class="s">&#39;IE&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span>
    <span class="k">if</span> <span class="nx">@version</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">@constructor</span><span class="p">.</span><span class="nx">versions</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Invalid version: &#39;</span><span class="si">#{</span><span class="nx">@version</span><span class="si">}</span><span class="s">&#39;&quot;</span>
    <span class="vi">@os = </span><span class="nx">pieces</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Invalid OS: &#39;</span><span class="si">#{</span><span class="nx">@os</span><span class="si">}</span><span class="s">&#39;&quot;</span> <span class="k">unless</span> <span class="nx">@os</span> <span class="k">in</span> <span class="nx">@constructor</span><span class="p">.</span><span class="nx">oses</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="validation-helpers">Validation Helpers</h3></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Throw an exception if the virtual machine is missing (not installed).</p></div></div><div class="code"><div class="wrapper">  <span class="nv">ensureMissing: </span><span class="nf">-&gt;</span>
    <span class="nx">@missing</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(missing) -&gt;</span> <span class="nx">missing</span> <span class="o">or</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&#39;not missing&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Throw an exception if the virtual machine is <em>not</em> missing (is installed).</p></div></div><div class="code"><div class="wrapper">  <span class="nv">ensureNotMissing: </span><span class="nf">-&gt;</span>
    <span class="nx">@missing</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(missing) -&gt;</span> <span class="o">!</span><span class="nx">missing</span> <span class="o">or</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&#39;missing&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Throw an exception if the virtual machine is running.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">ensureRunning: </span><span class="nf">-&gt;</span>
    <span class="nx">@running</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(running) -&gt;</span> <span class="nx">running</span> <span class="o">or</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&#39;not running&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Throw an exception if the virtual machine is <em>not</em> running (saved/off).</p></div></div><div class="code"><div class="wrapper">  <span class="nv">ensureNotRunning: </span><span class="nf">-&gt;</span>
    <span class="nx">@running</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(running) -&gt;</span> <span class="o">!</span><span class="nx">running</span> <span class="o">or</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&#39;running&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Throw an exception if the virtual machine has zero rearms left.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">ensureRearmsLeft: </span><span class="nf">-&gt;</span> <span class="nx">@rearmsLeft</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(rearmsLeft) -&gt;</span>
    <span class="nx">rearmsLeft</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">or</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&#39;no rearms left&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Throw an exception if the virtual machine's archive file is missing.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">ensureArchived: </span><span class="nf">-&gt;</span>
    <span class="nx">@archived</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(archived) -&gt;</span>
      <span class="nx">archived</span> <span class="o">or</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&#39;archive not present&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Throw an exception if the virtual machine's ova file is missing.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">ensureOvaed: </span><span class="nf">-&gt;</span>
    <span class="nx">@ovaed</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(ovaed) -&gt;</span> <span class="nx">ovaed</span> <span class="o">or</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&#39;ova not present&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="action-methods">Action Methods</h3></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Start the virtual machine. Throws an exception if it is already running or
cannot be started. If the <code>headless</code> argument is <code>false</code> (the default) then
the VM will be started in GUI mode.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">start: </span><span class="nf">(headless=false) -&gt;</span> <span class="nx">@ensureNotMissing</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span>
    <span class="nx">@ensureNotRunning</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span>
      <span class="nv">type = </span><span class="k">if</span> <span class="nx">headless</span> <span class="k">then</span> <span class="s">&#39;headless&#39;</span> <span class="k">else</span> <span class="s">&#39;gui&#39;</span>
      <span class="nx">@debug</span> <span class="s">&quot;start: </span><span class="si">#{</span><span class="nx">type</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="nx">@vbm</span><span class="p">(</span><span class="s">&#39;startvm&#39;</span><span class="p">,</span> <span class="s">&#39;--type&#39;</span><span class="p">,</span> <span class="nx">type</span><span class="p">).</span><span class="nx">then</span> <span class="o">=&gt;</span> <span class="nx">@waitForRunning</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Stop the virtual machine. Throws an exception if it is not running. If the
<code>save</code> argument is true (the default) then the VM state is saved. Otherwise,
the VM is powered off immediately which may result in data loss.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">stop: </span><span class="nf">(save=true) -&gt;</span> <span class="nx">@ensureNotMissing</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span> <span class="nx">@ensureRunning</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span>
    <span class="nv">type = </span><span class="k">if</span> <span class="nx">save</span> <span class="k">then</span> <span class="s">&#39;savestate&#39;</span> <span class="k">else</span> <span class="s">&#39;poweroff&#39;</span>
    <span class="nx">@debug</span> <span class="s">&quot;stop: </span><span class="si">#{</span><span class="nx">type</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nx">@vbm</span><span class="p">(</span><span class="s">&#39;controlvm&#39;</span><span class="p">,</span> <span class="nx">type</span><span class="p">).</span><span class="nx">then</span> <span class="o">=&gt;</span> <span class="nx">@waitForNotRunning</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Gracefully restart the virtual machine by calling <code>shutdown.exe</code>. Throws an
exception if it is not running.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">restart: </span><span class="nf">-&gt;</span> <span class="nx">@ensureNotMissing</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span> <span class="nx">@ensureRunning</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span>
    <span class="nx">@debug</span> <span class="s">&#39;restart&#39;</span>
    <span class="nx">@exec</span><span class="p">(</span><span class="s">&#39;shutdown.exe&#39;</span><span class="p">,</span> <span class="s">&#39;/r&#39;</span><span class="p">,</span> <span class="s">&#39;/t&#39;</span><span class="p">,</span> <span class="s">&#39;00&#39;</span><span class="p">).</span><span class="nx">then</span> <span class="o">=&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>TODO: Should return before GC comes back online but timing is hard.
TODO: Bullshit Vista pops up the activation thing.</p></div></div><div class="code"><div class="wrapper">      <span class="nx">@waitForNoGuestControl</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span> <span class="nx">@waitForGuestControl</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Open a URL in IE within the virtual machine. Throws an exception if it is
not running.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">open: </span><span class="nf">(url, wait=false) -&gt;</span> <span class="nx">@ensureNotMissing</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span>
    <span class="nx">@ensureRunning</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span> <span class="nx">@waitForNetwork</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span>
      <span class="nx">@debug</span> <span class="s">&quot;open: </span><span class="si">#{</span><span class="nx">url</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="k">if</span> <span class="nx">wait</span>
        <span class="k">return</span> <span class="nx">@exec</span> <span class="s">&#39;C:\\Program Files\\Internet Explorer\\iexplore.exe&#39;</span><span class="p">,</span> <span class="nx">url</span>
      <span class="nx">@exec</span> <span class="s">&#39;cmd.exe&#39;</span><span class="p">,</span> <span class="s">&#39;/c&#39;</span><span class="p">,</span> <span class="s">&#39;start&#39;</span><span class="p">,</span>
        <span class="s">&#39;C:\\Program Files\\Internet Explorer\\iexplore.exe&#39;</span><span class="p">,</span> <span class="nx">url</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Close running IE windows in the virtual machine, failing silently if IE is
not currently running.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">close: </span><span class="nf">-&gt;</span> <span class="nx">@ensureNotMissing</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span> <span class="nx">@ensureRunning</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span>
    <span class="nx">@debug</span> <span class="s">&#39;close&#39;</span>
    <span class="nx">@exec</span><span class="p">(</span><span class="s">&#39;taskkill.exe&#39;</span><span class="p">,</span> <span class="s">&#39;/f&#39;</span><span class="p">,</span> <span class="s">&#39;/im&#39;</span><span class="p">,</span> <span class="s">&#39;iexplore.exe&#39;</span><span class="p">).</span><span class="nx">fail</span> <span class="nf">-&gt;</span> <span class="nx">Q</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Rearm the virtual machine, extending the license for 90 days. Unfortunately,
rearming is only supported by the Win7 virtual machines at this time.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">rearm: </span><span class="nf">(delay=30000) -&gt;</span> <span class="nx">@ensureNotMissing</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span> <span class="nx">@ensureRunning</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span>
    <span class="nx">@ensureRearmsLeft</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span> <span class="nx">@waitForNetwork</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span>
      <span class="nx">@debug</span> <span class="s">&#39;rearm&#39;</span>
      <span class="nx">@rearmPrep</span><span class="p">(</span><span class="s">&#39;rearm&#39;</span><span class="p">).</span><span class="nx">then</span> <span class="o">=&gt;</span> <span class="nx">@ievmsTask</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span> <span class="nx">@meta</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(meta) =&gt;</span>
        <span class="nv">meta.rearms = </span><span class="p">(</span><span class="nx">meta</span><span class="p">.</span><span class="nx">rearms</span> <span class="o">?</span> <span class="p">[]).</span><span class="nx">concat</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">).</span><span class="nx">getTime</span><span class="p">()</span>
        <span class="nx">@meta</span><span class="p">(</span><span class="nx">meta</span><span class="p">).</span><span class="nx">then</span> <span class="o">=&gt;</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="nx">delay</span><span class="p">).</span><span class="nx">then</span> <span class="o">=&gt;</span> <span class="nx">@restart</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span>
          <span class="nx">@rearmPrep</span><span class="p">(</span><span class="s">&#39;ato&#39;</span><span class="p">).</span><span class="nx">then</span> <span class="o">=&gt;</span> <span class="nx">@ievmsTask</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span>
            <span class="nx">Q</span><span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="nx">delay</span><span class="p">).</span><span class="nx">then</span> <span class="o">=&gt;</span> <span class="nx">@restart</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Uninstall the virtual machine. Removes the virtual machine and hdd from
VirtualBox, keeping the archive or ova on disk.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">uninstall: </span><span class="nf">-&gt;</span> <span class="nx">@ensureNotMissing</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span> <span class="nx">@ensureNotRunning</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span>
    <span class="nx">@debug</span> <span class="s">&#39;uninstall&#39;</span>
    <span class="nx">@vbm</span> <span class="s">&#39;unregistervm&#39;</span><span class="p">,</span> <span class="s">&#39;--delete&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Install the virtual machine through ievms. Throws an exception if it is
already installed.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">install: </span><span class="nf">-&gt;</span> <span class="nx">@ensureMissing</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span>
    <span class="nx">@debug</span> <span class="s">&#39;install&#39;</span>
    <span class="nx">@constructor</span><span class="p">.</span><span class="nx">ievms</span> <span class="nx">@ievmsEnv</span><span class="p">(),</span> <span class="nx">@debug</span><span class="p">.</span><span class="nx">bind</span> <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Reinstall the virtual machine through ievms. Throws an exception if it is
running or not installed.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">reinstall: </span><span class="nf">-&gt;</span> <span class="nx">@uninstall</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span> <span class="nx">@install</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Restore the virtual machine to the <code>clean</code> snapshot created by ievms. Throws
an exception if it is missing or currently running.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">clean: </span><span class="nf">-&gt;</span> <span class="nx">@ensureNotMissing</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span> <span class="nx">@ensureNotRunning</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span>
    <span class="nx">@debug</span> <span class="s">&#39;clean&#39;</span>
    <span class="nx">@vbm</span><span class="p">(</span><span class="s">&#39;snapshot&#39;</span><span class="p">,</span> <span class="s">&#39;restore&#39;</span><span class="p">,</span> <span class="s">&#39;clean&#39;</span><span class="p">).</span><span class="nx">then</span> <span class="o">=&gt;</span> <span class="nx">@meta</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(meta) =&gt;</span>
      <span class="nv">meta.rearms = </span><span class="p">[]</span>
      <span class="nx">@meta</span> <span class="nx">meta</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Delete the archive file for the virtual machine. If the ova is not present,
the archive must be redownloaded to reinstall the virtual machine. Throws
an exception if the archive is not present.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">unarchive: </span><span class="nf">-&gt;</span> <span class="nx">@ensureArchived</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span>
    <span class="nx">@debug</span> <span class="s">&#39;unarchive&#39;</span>
    <span class="nx">Q</span><span class="p">.</span><span class="nx">nfcall</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">unlink</span><span class="p">,</span> <span class="nx">@fullArchive</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Delete the ova file for the virtual machine. If the archive is not present,
it must be redownloaded to reinstall the virtual machine. Throws an
exception if the ova is not present.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">unova: </span><span class="nf">-&gt;</span> <span class="nx">@ensureOvaed</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span>
    <span class="nx">@debug</span> <span class="s">&#39;unova&#39;</span>
    <span class="nx">Q</span><span class="p">.</span><span class="nx">nfcall</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">unlink</span><span class="p">,</span> <span class="nx">@fullOva</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Execute a command in the virtual machine. Throws an exception if it is
not installed or not running, or if the command fails. Waits for guest
control before proceeding.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">exec: </span><span class="nf">(cmd, args...) -&gt;</span> <span class="nx">@ensureNotMissing</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span> <span class="nx">@ensureRunning</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span>
    <span class="nx">@waitForGuestControl</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span>
      <span class="nx">@debug</span> <span class="s">&quot;exec: </span><span class="si">#{</span><span class="nx">cmd</span><span class="si">}</span><span class="s"> </span><span class="si">#{</span><span class="nx">args</span><span class="p">.</span><span class="nx">join</span> <span class="s">&#39; &#39;</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="nv">pass = </span><span class="k">if</span> <span class="nx">@os</span> <span class="o">isnt</span> <span class="s">&#39;WinXP&#39;</span> <span class="k">then</span> <span class="p">[</span><span class="s">&#39;--password&#39;</span><span class="p">,</span> <span class="s">&#39;Passw0rd!&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="p">[]</span>
      <span class="nv">args = </span><span class="p">[</span>
        <span class="s">&#39;exec&#39;</span><span class="p">,</span> <span class="s">&#39;--image&#39;</span><span class="p">,</span> <span class="nx">cmd</span><span class="p">,</span>
        <span class="s">&#39;--wait-exit&#39;</span><span class="p">,</span>
        <span class="s">&#39;--username&#39;</span><span class="p">,</span> <span class="s">&#39;IEUser&#39;</span><span class="p">,</span> <span class="nx">pass</span><span class="p">...,</span>
        <span class="s">&#39;--&#39;</span><span class="p">,</span> <span class="nx">args</span><span class="p">...</span>
      <span class="p">]</span>
      <span class="nx">@vbm</span> <span class="s">&#39;guestcontrol&#39;</span><span class="p">,</span> <span class="nx">args</span><span class="p">...</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Take a screenshot of the virtual machine and save it to disk. Throws an
exception if it is not installed or not running, or if the screenshot
command fails.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">screenshot: </span><span class="nf">(file) -&gt;</span> <span class="nx">@ensureNotMissing</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span> <span class="nx">@ensureRunning</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span>
    <span class="nx">@debug</span> <span class="s">&#39;screenshot&#39;</span>
    <span class="nx">@vbm</span> <span class="s">&#39;controlvm&#39;</span><span class="p">,</span> <span class="s">&#39;screenshotpng&#39;</span><span class="p">,</span> <span class="nx">file</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="attribute-methods">Attribute Methods</h3></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Determine the name of the zip file as used by modern.ie.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">archive: </span><span class="nf">-&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>For the reused XP vms, override the default to point to the IE6 archive.</p></div></div><div class="code"><div class="wrapper">    <span class="k">return</span> <span class="s">&#39;IE6_WinXP.zip&#39;</span> <span class="k">if</span> <span class="nx">@name</span> <span class="k">in</span> <span class="p">[</span><span class="s">&#39;IE7 - WinXP&#39;</span><span class="p">,</span> <span class="s">&#39;IE8 - WinXP&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="s">&#39;IE9_Win7.zip&#39;</span> <span class="k">if</span> <span class="nx">@name</span> <span class="k">in</span> <span class="p">[</span><span class="s">&#39;IE10 - Win7&#39;</span><span class="p">,</span> <span class="s">&#39;IE11 - Win7&#39;</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Simply replace dashes and spaces with an underscore and add <code>.zip</code>.</p></div></div><div class="code"><div class="wrapper">    <span class="s">&quot;</span><span class="si">#{</span><span class="nx">@name</span><span class="p">.</span><span class="nx">replace</span> <span class="s">&#39; - &#39;</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="si">}</span><span class="s">.zip&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Determine the full path to the archive file.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">fullArchive: </span><span class="nf">-&gt;</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="nx">@constructor</span><span class="p">.</span><span class="nx">ievmsHome</span><span class="p">,</span> <span class="nx">@archive</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Determine the name of the ova file as used by modern.ie.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">ova: </span><span class="nf">-&gt;</span>
    <span class="k">return</span> <span class="s">&#39;IE6 - WinXP.ova&#39;</span> <span class="k">if</span> <span class="nx">@name</span> <span class="k">in</span> <span class="p">[</span><span class="s">&#39;IE7 - WinXP&#39;</span><span class="p">,</span> <span class="s">&#39;IE8 - WinXP&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="s">&#39;IE9 - Win7.ova&#39;</span> <span class="k">if</span> <span class="nx">@name</span> <span class="k">in</span> <span class="p">[</span><span class="s">&#39;IE10 - Win7&#39;</span><span class="p">,</span> <span class="s">&#39;IE11 - Win7&#39;</span><span class="p">]</span>
    <span class="s">&quot;</span><span class="si">#{</span><span class="nx">@name</span><span class="si">}</span><span class="s">.ova&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Determine the full path to the ova file.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">fullOva: </span><span class="nf">-&gt;</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="nx">@constructor</span><span class="p">.</span><span class="nx">ievmsHome</span><span class="p">,</span> <span class="nx">@ova</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Generate the full URL to the modern.ie archive.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">url: </span><span class="nf">-&gt;</span> <span class="s">&#39;http://virtualization.modern.ie/vhd/IEKitV1_Final/VirtualBox/OSX/&#39;</span> <span class="o">+</span>
    <span class="nx">@archive</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Retrieve and parse the virtual machine info from <code>VBoxManage showvminfo</code>.
If <code>E_ACCESSDENIED</code> is caught, the command will be retried up to 3 times
before rejecting the promise.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">info: </span><span class="nf">(retries=3, delay=250) -&gt;</span>
    <span class="nx">@vbm</span><span class="p">(</span><span class="s">&#39;showvminfo&#39;</span><span class="p">,</span> <span class="s">&#39;--machinereadable&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">@parseInfo</span><span class="p">).</span><span class="nx">fail</span> <span class="nf">(err) =&gt;</span>
      <span class="k">return</span> <span class="nx">Q</span> <span class="nv">VMState: </span><span class="s">&#39;missing&#39;</span> <span class="k">if</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/VBOX_E_OBJECT_NOT_FOUND/</span>
      <span class="k">if</span> <span class="nx">retries</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/E_ACCESSDENIED/</span>
        <span class="nx">@debug</span> <span class="s">&quot;info: retrying (</span><span class="si">#{</span><span class="nx">retries</span> <span class="o">-</span> <span class="mi">1</span><span class="si">}</span><span class="s"> retries left)&quot;</span>
        <span class="k">return</span> <span class="nx">@info</span> <span class="nx">retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">delay</span>
      <span class="k">throw</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Promise a value from <code>IEVM.status</code> representing the vm's current status.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">status: </span><span class="nf">-&gt;</span> <span class="nx">@statusName</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(key) =&gt;</span> <span class="nx">@constructor</span><span class="p">.</span><span class="nx">status</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Promise a key from <code>IEVM.status</code> representing the vm's current status.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">statusName: </span><span class="nf">-&gt;</span> <span class="nx">@info</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(info) -&gt;</span> <span class="nx">info</span><span class="p">.</span><span class="nx">VMState</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Promise a <code>Date</code> object representing when the archive was last uploaded to
the modern.ie website. Caches the date as a property on the instance.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">uploaded: </span><span class="nf">-&gt;</span>
    <span class="k">return</span> <span class="nx">Q</span> <span class="nx">@_uploaded</span> <span class="k">if</span> <span class="nx">@_uploaded</span><span class="o">?</span>
    <span class="nv">deferred = </span><span class="nx">Q</span><span class="p">.</span><span class="nx">defer</span><span class="p">()</span>
    <span class="nv">opts = </span><span class="nx">url</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">@url</span><span class="p">()</span>
    <span class="nv">opts.method = </span><span class="s">&#39;HEAD&#39;</span>
    <span class="nv">req = </span><span class="nx">http</span><span class="p">.</span><span class="nx">request</span> <span class="nx">opts</span><span class="p">,</span> <span class="nf">(res) =&gt;</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;data&#39;</span><span class="p">,</span> <span class="nf">(chunk) -&gt;</span>
      <span class="vi">@_uploaded = </span><span class="k">new</span> <span class="nb">Date</span> <span class="nx">res</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s">&#39;last-modified&#39;</span><span class="p">]</span>
      <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">@_uploaded</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;error&#39;</span><span class="p">,</span> <span class="nf">(err) -&gt;</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span> <span class="nx">err</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
    <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Promise getter/setter for VM metadata.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">meta: </span><span class="nf">(data) -&gt;</span> <span class="k">if</span> <span class="nx">data</span><span class="o">?</span> <span class="k">then</span> <span class="nx">@setMeta</span> <span class="nx">data</span> <span class="k">else</span> <span class="nx">@getMeta</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Promise a boolean indicating whether the VM is missing.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">missing: </span><span class="nf">-&gt;</span> <span class="nx">@status</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(status) =&gt;</span> <span class="nx">status</span> <span class="o">is</span> <span class="nx">@constructor</span><span class="p">.</span><span class="nx">status</span><span class="p">.</span><span class="nx">MISSING</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Promise a boolean indicating whether the VM is running.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">running: </span><span class="nf">-&gt;</span> <span class="nx">@status</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(status) =&gt;</span> <span class="nx">status</span> <span class="o">is</span> <span class="nx">@constructor</span><span class="p">.</span><span class="nx">status</span><span class="p">.</span><span class="nx">RUNNING</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Promise a boolean indicating whether the VM is expired.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">expired: </span><span class="nf">-&gt;</span> <span class="nx">@expires</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(expires) =&gt;</span> <span class="o">!</span><span class="nx">expires</span><span class="o">?</span> <span class="o">or</span> <span class="nx">expires</span> <span class="o">&lt;</span> <span class="k">new</span> <span class="nb">Date</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Promise a boolean indicating whether the archive exists on disk.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">archived: </span><span class="nf">-&gt;</span>
    <span class="nv">deferred = </span><span class="nx">Q</span><span class="p">.</span><span class="nx">defer</span><span class="p">()</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">exists</span> <span class="nx">@fullArchive</span><span class="p">(),</span> <span class="nf">(archived) -&gt;</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">archived</span>
    <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Promise a boolean indicating whether the archive exists on disk.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">ovaed: </span><span class="nf">-&gt;</span>
    <span class="nv">deferred = </span><span class="nx">Q</span><span class="p">.</span><span class="nx">defer</span><span class="p">()</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">exists</span> <span class="nx">@fullOva</span><span class="p">(),</span> <span class="nf">(ovaed) -&gt;</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">ovaed</span>
    <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Promise a <code>Date</code> object representing when the VM will expire.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">expires: </span><span class="nf">-&gt;</span> <span class="nx">@missing</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(missing) =&gt;</span>
    <span class="k">return</span> <span class="kc">null</span> <span class="k">if</span> <span class="nx">missing</span>
    <span class="nv">thirtyDays = </span><span class="mi">30</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span>
    <span class="nv">ninetyDays = </span><span class="nx">thirtyDays</span> <span class="o">*</span> <span class="mi">3</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>XP virtual machines expire after 30 days from creation. Others get 90.</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">@os</span> <span class="o">is</span> <span class="s">&#39;WinXP&#39;</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">@hddCreated</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(created) -&gt;</span>
      <span class="k">new</span> <span class="nb">Date</span> <span class="nx">created</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="nx">thirtyDays</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Try to fetch last rearm date from metadata.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@rearmDates</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(rearms) =&gt;</span>
      <span class="k">if</span> <span class="nx">rearms</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add ninety days to the most recent rearm date.</p></div></div><div class="code"><div class="wrapper">        <span class="k">new</span> <span class="nb">Date</span> <span class="nx">rearms</span><span class="p">[</span><span class="nx">rearms</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="nx">ninetyDays</span>
      <span class="k">else</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Fall back to the original date when the hdd was last modified.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">@hddCreated</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(created) -&gt;</span> <span class="k">new</span> <span class="nb">Date</span> <span class="nx">created</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="nx">ninetyDays</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Promise an array of rearm dates or empty array if none exist.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">rearmDates: </span><span class="nf">-&gt;</span> <span class="nx">@meta</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(meta) =&gt;</span>
    <span class="k">return</span> <span class="p">[]</span> <span class="k">unless</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">rearms</span><span class="o">?</span> <span class="o">and</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">rearms</span><span class="p">.</span><span class="nx">length</span><span class="o">?</span>
    <span class="k">new</span> <span class="nb">Date</span> <span class="nx">d</span> <span class="k">for</span> <span class="nx">d</span> <span class="k">in</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">rearms</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Promise the number of rearms left for the VM.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">rearmsLeft: </span><span class="nf">-&gt;</span> <span class="nx">@rearmDates</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(rearms) =&gt;</span>
    <span class="nx">@constructor</span><span class="p">.</span><span class="nx">rearms</span><span class="p">[</span><span class="nx">@os</span><span class="p">]</span> <span class="o">-</span> <span class="nx">rearms</span><span class="p">.</span><span class="nx">length</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="utilities">Utilities</h3></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Output a debug message for the virtual machine.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">debug: </span><span class="nf">(msg) -&gt;</span>
    <span class="nx">@_debug</span> <span class="o">?=</span> <span class="nx">debug</span> <span class="s">&quot;iectrl:</span><span class="si">#{</span><span class="nx">@name</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nx">@_debug</span> <span class="nx">msg</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Build an environment hash to pass to ievms for installation.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">ievmsEnv: </span><span class="nf">-&gt;</span>
    <span class="nv">IEVMS_VERSIONS: </span><span class="nx">@version</span>
    <span class="nv">REUSE_XP: </span><span class="k">if</span> <span class="nx">@version</span> <span class="k">in</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span> <span class="o">and</span> <span class="nx">@os</span> <span class="o">is</span> <span class="s">&#39;WinXP&#39;</span> <span class="k">then</span> <span class="s">&#39;yes&#39;</span> <span class="k">else</span> <span class="s">&#39;no&#39;</span>
    <span class="nv">REUSE_WIN7: </span><span class="k">if</span> <span class="nx">@version</span> <span class="k">in</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">]</span> <span class="o">and</span> <span class="nx">@os</span> <span class="o">is</span> <span class="s">&#39;Win7&#39;</span> <span class="k">then</span> <span class="s">&#39;yes&#39;</span> <span class="k">else</span> <span class="s">&#39;no&#39;</span>
    <span class="nv">INSTALL_PATH: </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">ievmsHome</span>
    <span class="nv">HOME: </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">HOME</span>
    <span class="nv">PATH: </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PATH</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Run a <code>VBoxManage</code> command and promise the stdout contents.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">vbm: </span><span class="nf">(args...) -&gt;</span>
    <span class="vi">@_vbmQueue = </span><span class="nx">Q</span><span class="p">()</span> <span class="k">if</span> <span class="o">!</span><span class="nx">@_vbmQueue</span><span class="o">?</span> <span class="o">or</span> <span class="nx">@_vbmQueue</span><span class="p">.</span><span class="nx">isRejected</span><span class="p">()</span>
    <span class="vi">@_vbmQueue = </span><span class="nx">@_vbmQueue</span><span class="p">.</span><span class="nx">then</span> <span class="o">=&gt;</span>
      <span class="nv">deferred = </span><span class="nx">Q</span><span class="p">.</span><span class="nx">defer</span><span class="p">()</span>
      <span class="nv">command = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">vbm</span> <span class="nx">args</span><span class="p">.</span><span class="nx">shift</span><span class="p">(),</span> <span class="p">[</span><span class="nx">@name</span><span class="p">].</span><span class="nx">concat</span> <span class="nx">args</span>
      <span class="nx">child_process</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">command</span><span class="p">,</span> <span class="nf">(err, stdout, stderr) =&gt;</span>
        <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span><span class="o">?</span>
        <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">stdout</span>
      <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Parse the "machinereadable" <code>VBoxManage</code> vm info output format.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">parseInfo: </span><span class="nf">(s) -&gt;</span>
    <span class="nv">obj = </span><span class="p">{}</span>
    <span class="k">for</span> <span class="nx">line</span> <span class="k">in</span> <span class="nx">s</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">split</span> <span class="s">&quot;\n&quot;</span>
      <span class="nv">pieces = </span><span class="nx">line</span><span class="p">.</span><span class="nx">split</span> <span class="s">&#39;=&#39;</span>
      <span class="nx">obj</span><span class="p">[</span><span class="nx">pieces</span><span class="p">.</span><span class="nx">shift</span><span class="p">()]</span> <span class="o">=</span> <span class="nx">pieces</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^&quot;/</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span> <span class="sr">/&quot;$/</span><span class="p">,</span> <span class="s">&#39;&#39;</span>
    <span class="nx">obj</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Parse the ievms meta data stored in the VirtualBox <code>extradata</code>.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">parseMeta: </span><span class="nf">(data) -&gt;</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">data</span><span class="p">.</span><span class="nx">replace</span> <span class="s">&#39;Value: &#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Promise to set the VM metadata.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">setMeta: </span><span class="nf">(data) -&gt;</span> <span class="nx">@vbm</span> <span class="s">&#39;setextradata&#39;</span><span class="p">,</span> <span class="s">&#39;ievms&#39;</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="nx">data</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Promise to get the VM metadata. Returns empty object on failure.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getMeta: </span><span class="nf">-&gt;</span> <span class="nx">@vbm</span><span class="p">(</span><span class="s">&#39;getextradata&#39;</span><span class="p">,</span> <span class="s">&#39;ievms&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">@parseMeta</span><span class="p">).</span><span class="nx">fail</span> <span class="nf">(err) -&gt;</span> <span class="nx">Q</span> <span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Seed the <code>ievms.bat</code> file in the virtual machine with a <code>slmgr</code> command.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">rearmPrep: </span><span class="nf">(cmd) -&gt;</span> <span class="nx">@exec</span> <span class="s">&#39;cmd.exe&#39;</span><span class="p">,</span> <span class="s">&#39;/c&#39;</span><span class="p">,</span>
    <span class="s">&quot;echo slmgr.vbs /</span><span class="si">#{</span><span class="nx">cmd</span><span class="si">}</span><span class="s"> &gt;C:\\Users\\IEUser\\ievms.bat&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Execute the <code>ievms</code> scheduled task in the virtual machine.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">ievmsTask: </span><span class="nf">-&gt;</span> <span class="nx">@exec</span> <span class="s">&#39;schtasks.exe&#39;</span><span class="p">,</span> <span class="s">&#39;/run&#39;</span><span class="p">,</span> <span class="s">&#39;/tn&#39;</span><span class="p">,</span> <span class="s">&#39;ievms&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Promise the UUID of the VM's hdd.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">hddUuid: </span><span class="nf">-&gt;</span> <span class="nx">@info</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(info) =&gt;</span>
    <span class="nx">info</span><span class="p">[</span><span class="s">&#39;&quot;SATA Controller-ImageUUID-0-0&quot;&#39;</span><span class="p">]</span> <span class="o">?</span>
      <span class="nx">info</span><span class="p">[</span><span class="s">&#39;&quot;IDE Controller-ImageUUID-0-0&quot;&#39;</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Promise an object representing the base hdd.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">hdd: </span><span class="nf">-&gt;</span> <span class="nx">@constructor</span><span class="p">.</span><span class="nx">hdds</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(hdds) =&gt;</span> <span class="nx">@hddUuid</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(uid) =&gt;</span>
    <span class="k">return</span> <span class="kc">null</span> <span class="k">unless</span> <span class="nx">uid</span><span class="o">?</span> <span class="o">and</span> <span class="nx">hdds</span><span class="p">[</span><span class="nx">uid</span><span class="p">]</span>
    <span class="nv">uid = </span><span class="nx">hdds</span><span class="p">[</span><span class="nx">uid</span><span class="p">][</span><span class="s">&#39;Parent UUID&#39;</span><span class="p">]</span> <span class="k">while</span> <span class="nx">hdds</span><span class="p">[</span><span class="nx">uid</span><span class="p">][</span><span class="s">&#39;Parent UUID&#39;</span><span class="p">]</span> <span class="o">isnt</span> <span class="s">&#39;base&#39;</span>
    <span class="nx">hdds</span><span class="p">[</span><span class="nx">uid</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Promise an <code>fs.stat</code> object for the VM's base hdd file.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">hddStat: </span><span class="nf">-&gt;</span> <span class="nx">@hdd</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(hdd) =&gt;</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">nfcall</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">,</span> <span class="nx">hdd</span><span class="p">.</span><span class="nx">Location</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Promise a <code>Date</code> object representing when the hdd file was created.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">hddCreated: </span><span class="nf">-&gt;</span> <span class="nx">@hddStat</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(stat) =&gt;</span> <span class="nx">stat</span><span class="p">.</span><span class="nx">mtime</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="waiting-room">Waiting Room</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nv">_waitForStatus: </span><span class="nf">(statuses, deferred, delay=1000) -&gt;</span>
    <span class="nv">statuses = </span><span class="p">[].</span><span class="nx">concat</span> <span class="nx">statuses</span>
    <span class="nv">statusNames = </span><span class="p">(</span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">statusName</span> <span class="nx">s</span> <span class="k">for</span> <span class="nx">s</span> <span class="k">in</span> <span class="nx">statuses</span><span class="p">).</span><span class="nx">join</span> <span class="s">&#39;, &#39;</span>
    <span class="nx">@debug</span> <span class="s">&quot;_waitForStatus: </span><span class="si">#{</span><span class="nx">statusNames</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">return</span> <span class="kc">null</span> <span class="k">if</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">.</span><span class="nx">isRejected</span><span class="p">()</span>
    <span class="nx">@status</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(status) =&gt;</span>
      <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">status</span> <span class="k">if</span> <span class="nx">status</span> <span class="k">in</span> <span class="nx">statuses</span>
      <span class="nx">Q</span><span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="nx">delay</span><span class="p">).</span><span class="nx">then</span> <span class="o">=&gt;</span> <span class="nx">@_waitForStatus</span> <span class="nx">statuses</span><span class="p">,</span> <span class="nx">deferred</span><span class="p">,</span> <span class="nx">delay</span>

  <span class="nv">waitForRunning: </span><span class="nf">(timeout=60000, delay) -&gt;</span>
    <span class="nx">@debug</span> <span class="s">&#39;waitForRunning&#39;</span>
    <span class="nv">deferred = </span><span class="nx">Q</span><span class="p">.</span><span class="nx">defer</span><span class="p">()</span>
    <span class="nx">@_waitForStatus</span><span class="p">(</span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">status</span><span class="p">.</span><span class="nx">RUNNING</span><span class="p">,</span> <span class="nx">deferred</span><span class="p">,</span> <span class="nx">delay</span><span class="p">).</span><span class="nx">fail</span> <span class="nf">(err) -&gt;</span>
      <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span> <span class="nx">err</span>
    <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">.</span><span class="nx">timeout</span> <span class="nx">timeout</span>

  <span class="nv">waitForNotRunning: </span><span class="nf">(timeout=60000, delay) -&gt;</span>
    <span class="nx">@debug</span> <span class="s">&#39;waitForNotRunning&#39;</span>
    <span class="nv">deferred = </span><span class="nx">Q</span><span class="p">.</span><span class="nx">defer</span><span class="p">()</span>
    <span class="nx">@_waitForStatus</span><span class="p">([</span>
      <span class="nx">@constructor</span><span class="p">.</span><span class="nx">status</span><span class="p">.</span><span class="nx">POWEROFF</span>
      <span class="nx">@constructor</span><span class="p">.</span><span class="nx">status</span><span class="p">.</span><span class="nx">PAUSED</span>
      <span class="nx">@constructor</span><span class="p">.</span><span class="nx">status</span><span class="p">.</span><span class="nx">SAVED</span>
    <span class="p">],</span> <span class="nx">deferred</span><span class="p">,</span> <span class="nx">delay</span><span class="p">).</span><span class="nx">fail</span> <span class="nf">(err) -&gt;</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span> <span class="nx">err</span>
    <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">.</span><span class="nx">timeout</span> <span class="nx">timeout</span>

  <span class="nv">_waitForGuestControl: </span><span class="nf">(deferred, delay=1000) -&gt;</span>
    <span class="nx">@debug</span> <span class="s">&#39;_waitForGuestControl&#39;</span>
    <span class="k">return</span> <span class="kc">null</span> <span class="k">if</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">.</span><span class="nx">isRejected</span><span class="p">()</span>
    <span class="nx">@info</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(info) =&gt;</span>
      <span class="nv">runlevel = </span><span class="nx">info</span><span class="p">.</span><span class="nx">GuestAdditionsRunLevel</span>
      <span class="nx">@debug</span> <span class="s">&quot;_waitForGuestControl: runlevel </span><span class="si">#{</span><span class="nx">runlevel</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span> <span class="kc">true</span> <span class="k">if</span> <span class="nx">runlevel</span><span class="o">?</span> <span class="o">and</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">runlevel</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span>
      <span class="nx">Q</span><span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="nx">delay</span><span class="p">).</span><span class="nx">then</span> <span class="o">=&gt;</span> <span class="nx">@_waitForGuestControl</span> <span class="nx">deferred</span><span class="p">,</span> <span class="nx">delay</span>

  <span class="nv">waitForGuestControl: </span><span class="nf">(timeout=60000, delay) -&gt;</span>
    <span class="nx">@waitForRunning</span><span class="p">().</span><span class="nx">then</span> <span class="o">=&gt;</span>
      <span class="nv">deferred = </span><span class="nx">Q</span><span class="p">.</span><span class="nx">defer</span><span class="p">()</span>
      <span class="nx">@_waitForGuestControl</span><span class="p">(</span><span class="nx">deferred</span><span class="p">,</span> <span class="nx">delay</span><span class="p">).</span><span class="nx">fail</span> <span class="nf">(err) -&gt;</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span> <span class="nx">err</span>
      <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">.</span><span class="nx">timeout</span> <span class="nx">timeout</span>

  <span class="nv">_waitForNoGuestControl: </span><span class="nf">(deferred, delay=1000) -&gt;</span>
    <span class="nx">@debug</span> <span class="s">&#39;_waitForNoGuestControl&#39;</span>
    <span class="k">return</span> <span class="kc">null</span> <span class="k">if</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">.</span><span class="nx">isRejected</span><span class="p">()</span>
    <span class="nx">@info</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(info) =&gt;</span>
      <span class="nv">runlevel = </span><span class="nx">info</span><span class="p">.</span><span class="nx">GuestAdditionsRunLevel</span>
      <span class="nx">@debug</span> <span class="s">&quot;waitForNoGuestControl: runlevel </span><span class="si">#{</span><span class="nx">runlevel</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span> <span class="kc">true</span> <span class="k">if</span> <span class="o">!</span><span class="nx">runlevel</span><span class="o">?</span> <span class="o">or</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">runlevel</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span>
      <span class="nx">Q</span><span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="nx">delay</span><span class="p">).</span><span class="nx">then</span> <span class="o">=&gt;</span> <span class="nx">@_waitForNoGuestControl</span> <span class="nx">deferred</span><span class="p">,</span> <span class="nx">delay</span>

  <span class="nv">waitForNoGuestControl: </span><span class="nf">(timeout=60000, delay) -&gt;</span>
    <span class="nv">deferred = </span><span class="nx">Q</span><span class="p">.</span><span class="nx">defer</span><span class="p">()</span>
    <span class="nx">@_waitForNoGuestControl</span><span class="p">(</span><span class="nx">deferred</span><span class="p">,</span> <span class="nx">delay</span><span class="p">).</span><span class="nx">fail</span> <span class="nf">(err) -&gt;</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span> <span class="nx">err</span>
    <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">.</span><span class="nx">timeout</span> <span class="nx">timeout</span>

  <span class="nv">waitForNetwork: </span><span class="nf">(host=@constructor.hostIp, retries=5, delay=3000) -&gt;</span>
    <span class="nx">@debug</span> <span class="s">&#39;waitForNetwork&#39;</span>
    <span class="nx">@exec</span><span class="p">(</span><span class="s">&#39;ping.exe&#39;</span><span class="p">,</span> <span class="nx">host</span><span class="p">,</span> <span class="s">&#39;-n&#39;</span><span class="p">,</span> <span class="s">&#39;1&#39;</span><span class="p">).</span><span class="nx">fail</span> <span class="nf">(err) =&gt;</span>
      <span class="k">throw</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">retries</span> <span class="o">&lt;=</span> <span class="mi">0</span>
      <span class="nx">Q</span><span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="nx">delay</span><span class="p">).</span><span class="nx">then</span> <span class="o">=&gt;</span>
        <span class="nx">@waitForNetwork</span> <span class="nx">host</span><span class="p">,</span> <span class="nx">retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">delay</span> <span class="k">if</span> <span class="nx">retries</span> <span class="o">&gt;</span> <span class="mi">0</span>

<span class="nv">module.exports = </span><span class="nx">IEVM</span></div></div></div></div></body></html>